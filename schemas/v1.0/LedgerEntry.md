## ğŸ“– äºŒã€ã€ŠLedgerEntry v1.0ã€‹è¯´æ˜æ–‡æ¡£

### 1. ç‰ˆæœ¬ä¿¡æ¯

- åç§°ï¼š`LedgerEntry`
- ç‰ˆæœ¬ï¼š`v1.0`
- ç¼–å·ï¼š`S-DOC-001-03`
- çŠ¶æ€ï¼š`final`
- è”é‚¦æˆå‘˜ï¼šCREEP Schema Federation â€“ S-03ï¼šFinancialLedger
- å…³è”ç»“æ„ï¼š
    - S-01ï¼š`AssetSnapshot`
    - S-02ï¼š`TaskOrder`
    - S-04ï¼š`AssetEvent`
    - S-05ï¼š`AssetGraph`

> å…±è¯†ï¼š
> 
> 
> **LedgerEntry æ˜¯â€œé’±â€çš„å”¯ä¸€äº‹å®æ¥æº**ã€‚
> 
> AssetSnapshot/TaskOrder åªå­˜â€œé™æ€è§†è§’â€çš„æˆæœ¬/é¢„ç®—ï¼Œè€ŒçœŸæ­£çš„ç°é‡‘æµã€æˆæœ¬æ¶ˆè€—ã€æ”¶å…¥è®°å½•å…¨éƒ¨è½åœ¨ LedgerEntry ä¸Šã€‚
> 

---

### 2. ç»“æ„æ€»è§ˆ

`LedgerEntry v1.0` æè¿°çš„æ˜¯ï¼š

> â€œä¸€æ¬¡èµ„é‡‘æµåŠ¨ / æˆæœ¬ç¡®è®¤ / æ”¶å…¥ç¡®è®¤çš„åŸå­è®°å½•â€ã€‚
> 

ç‰¹ç‚¹ï¼š

- æ¯æ¡è®°å½•åªä»£è¡¨ **ä¸€æ¬¡é‡‘é¢å˜åŒ–**ï¼›
- `amount` æ°¸è¿œä¸ºæ­£ï¼Œæ–¹å‘ç”± `direction: IN/OUT` å†³å®šï¼›
- å¯ä»¥å½’å› åˆ°ï¼š
    - å“ªä¸ªç§Ÿæˆ· / é¡¹ç›® / ç¯å¢ƒï¼›
    - å“ªä¸ªä»»åŠ¡ï¼ˆTaskOrderï¼‰ï¼›
    - å“ªä¸ªèµ„äº§ï¼ˆAssetSnapshotï¼‰ï¼›
    - å“ªä¸ªå¤–éƒ¨è´¦å•æˆ–äº¤æ˜“ï¼ˆexternal_refï¼‰ï¼›
- å¯ä»¥æŒ‰ `reason` / `category` / `tags` åš FinOps æŠ¥è¡¨ä¸ç­–ç•¥ã€‚

---

### 3. å­—æ®µè¯´æ˜

### 3.1 æ ‡è¯†ä¸å¤šç§Ÿæˆ·ç»´åº¦

- `ledger_entry_id`
    - ç±»å‹ï¼šUUID å­—ç¬¦ä¸²
    - å«ä¹‰ï¼šè´¦ç›®è¡Œå”¯ä¸€ IDã€‚
    - è¯´æ˜ï¼šä»»ä½•è°ƒæ•´ã€å†²é”€éƒ½åº”é€šè¿‡æ–°å¢ LedgerEntryï¼Œè€Œä¸æ˜¯ä¿®æ”¹æ—§è®°å½•ã€‚
- `tenant_id`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²
    - å«ä¹‰ï¼šè´¦ç›®æ‰€å±ç§Ÿæˆ·/ä¼ä¸šã€‚
- `project_id`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²ï¼Œå¯ç©º
    - å«ä¹‰ï¼šé¡¹ç›® / æˆæœ¬ä¸­å¿ƒ / éƒ¨é—¨ã€‚
    - ç”¨é€”ï¼šæ”¯æŒâ€œæŒ‰é¡¹ç›®ç®—é’±â€ã€‚
- `env`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²
    - ç¤ºä¾‹ï¼š`"prod"`, `"staging"`, `"dev"`
    - å«ä¹‰ï¼šç¯å¢ƒç»´åº¦ï¼Œä¸ AssetSnapshot / TaskOrder çš„ `env` å¯¹é½ã€‚
    - ç”¨é€”ï¼šé¿å…æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„è´¹ç”¨æ··åœ¨ä¸€èµ·ã€‚

---

### 3.2 å…³è”ç»´åº¦ï¼ˆTask / Asset / å¤–éƒ¨ä¸–ç•Œï¼‰

- `asset_id`
    - ç±»å‹ï¼šUUID å­—ç¬¦ä¸²ï¼Œå¯ç©º
    - å«ä¹‰ï¼šè¿™ç¬”é’±ä¸å“ªä¸ªèµ„äº§å…³è”ï¼ˆå¦‚æŸ IPã€æŸ VCCã€æŸ VPS èŠ‚ç‚¹ç­‰ï¼‰ã€‚
- `task_id`
    - ç±»å‹ï¼šUUID å­—ç¬¦ä¸²ï¼Œå¯ç©º
    - å«ä¹‰ï¼šè¿™ç¬”é’±æ˜¯ç”±å“ªä¸ª TaskOrder é©±åŠ¨äº§ç”Ÿçš„ã€‚
    - ç¤ºä¾‹ï¼š
        - æŸæ¬¡æŠ¢ç¥¨ä»»åŠ¡äº§ç”Ÿçš„æ”¯å‡º / æ”¶å…¥ï¼›
        - æŸæ¬¡ E2E QA ä»»åŠ¡äº§ç”Ÿçš„äº‘æˆæœ¬ã€‚
- `external_ref`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²ï¼Œå¯ç©º
    - å«ä¹‰ï¼šå¤–éƒ¨è´¦å• / äº¤æ˜“ / å‘ç¥¨çš„å¼•ç”¨ IDï¼Œä¾‹å¦‚ï¼š
        - äº‘å‚å•†è´¦å•è¡Œ IDï¼›
        - é“¶è¡Œ / VCC é€šé“çš„äº¤æ˜“æµæ°´å·ï¼›
        - åŒºå—é“¾äº¤æ˜“å“ˆå¸Œã€‚
    - ç”¨é€”ï¼šå¯¹è´¦ã€å®¡è®¡ã€è¿½æº¯ã€‚

> çº¦å®šï¼ˆé€»è¾‘å±‚ï¼‰ï¼š
> 
> - ç†æƒ³æƒ…å†µä¸‹ï¼Œ`asset_id` / `task_id` / `external_ref` è‡³å°‘æœ‰ä¸€ä¸ªä¸ä¸ºç©ºï¼›
> - å…·ä½“å¼ºçº¦æŸç”±ä¸šåŠ¡å®ç°å±‚è´Ÿè´£ï¼Œè€Œä¸æ˜¯ Schema ç›´æ¥ enforceã€‚

---

### 3.3 é‡‘é¢ä¸æ–¹å‘

- `direction`
    - ç±»å‹ï¼šæšä¸¾ï¼Œ`"IN"` æˆ– `"OUT"`
    - å«ä¹‰ï¼š
        - `IN`ï¼šé’±æµå…¥ç§Ÿæˆ·ï¼ˆæ”¶å…¥ / é€€æ¬¾ / è¿”åˆ©ï¼‰ï¼›
        - `OUT`ï¼šé’±æµå‡ºç§Ÿæˆ·ï¼ˆæˆæœ¬ / æ‰‹ç»­è´¹ / ç¨è´¹ï¼‰ã€‚
- `amount`
    - ç±»å‹ï¼šæ•°å€¼ â‰¥ 0
    - å«ä¹‰ï¼šæœ¬æ¬¡èµ„é‡‘å˜åŠ¨çš„ç»å¯¹å€¼ã€‚
    - è¯´æ˜ï¼š
        - è´Ÿå·ä¸è¡¨ç¤ºæ–¹å‘ï¼Œæ–¹å‘åªçœ‹ `direction`ï¼›
        - å¦‚éœ€å†²é”€ï¼Œåº”è¯¥å»ºç«‹ä¸€æ¡ç›¸åæ–¹å‘ (`IN` â†” `OUT`) ä¸”ç›¸åŒ `amount` çš„æ–°è®°å½•ï¼Œå¹¶é€šè¿‡ `meta` è®°å½•å…³è”ã€‚
- `currency`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²ï¼Œ3 ä½å¤§å†™å­—æ¯ï¼ˆISO 4217 æˆ–ä¸šåŠ¡å†…çº¦å®šï¼Œå¦‚ `USDT`ï¼‰
    - å«ä¹‰ï¼šæœ¬æ¡ LedgerEntry çš„è®°è´¦å¸ç§ã€‚
    - è¯´æ˜ï¼š
        - ä¸åšå®æ—¶æ±‡ç‡è½¬æ¢ï¼›
        - æ±‡æ€»æŠ¥è¡¨éœ€è¦ç”±ä¸Šå±‚æ ¹æ®æ±‡ç‡åšæŠ˜ç®—ã€‚

---

### 3.4 å½’å› ä¸åˆ†ç±»

- `reason`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²
    - å«ä¹‰ï¼šç®€è¦ã€æŠ€æœ¯è§†è§’çš„â€œåŸå› åˆ†ç±»â€ã€‚æ¨èæšä¸¾ï¼ˆé Schema å¼ºåˆ¶ï¼‰ï¼š
        - `PROCUREMENT`ï¼šé‡‡è´­åŸææ–™ / èµ„æºï¼ˆä¹° IPã€ä¹° VPSã€ä¹° VCCâ€¦ï¼‰
        - `GAS_FEE`ï¼šé“¾ä¸Š Gas
        - `TASK_BURN`ï¼šä»»åŠ¡æ‰§è¡Œæ‰£è´¹ï¼ˆå¦‚æŒ‰è°ƒç”¨é‡ä»˜è´¹ï¼‰
        - `SUBSCRIPTION`ï¼šSaaS è®¢é˜…ï¼ˆAWSã€Slack ç­‰ï¼‰
        - `SALE_REVENUE`ï¼šå”®å–äº§å“ï¼ˆç¥¨/Token/è´¦å·ï¼‰çš„æ”¶å…¥
        - `REFUND`ï¼šé€€æ¬¾
        - `ADJUSTMENT`ï¼šäººå·¥è°ƒè´¦ / ç³»ç»Ÿè°ƒæ•´
- `category`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²
    - å«ä¹‰ï¼šé¢å‘ä¸šåŠ¡å’Œè´¢åŠ¡çš„å®è§‚åˆ†ç±»ï¼Œç”¨äºæŠ¥è¡¨èšåˆã€‚æ¨èæšä¸¾ï¼ˆåŒæ ·é Schema å¼ºåˆ¶ï¼‰ï¼š
        - `CLOUD_COST`
        - `NETWORK_COST`
        - `PAYMENT_COST`
        - `INFRA_COST`
        - `PRODUCT_REVENUE`
        - `OTHER_REVENUE`
        - `TAX`
        - `FEE`
    - ä½¿ç”¨å»ºè®®ï¼š
        - `reason` æ›´åâ€œåŠ¨ä½œ/åŸå› â€ï¼›
        - `category` æ›´åâ€œæˆæœ¬/æ”¶å…¥çš„ç§‘ç›®ç»´åº¦â€ã€‚
- `tags`
    - ç±»å‹ï¼šå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯ç©º
    - å«ä¹‰ï¼šè‡ªç”±æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼š
        - `["black_friday", "taylor_swift", "experiment_group_A"]`
    - ç”¨é€”ï¼šä¸º FinOps / BI æä¾›æ›´çµæ´»çš„è¿‡æ»¤ç»´åº¦ã€‚

---

### 3.5 å…ƒä¿¡æ¯ï¼ˆmetaï¼‰

- `meta`
    - ç±»å‹ï¼šå¯¹è±¡
    - å«ä¹‰ï¼šä¸å…·ä½“è´¦ç›®ç›¸å…³çš„æ‰©å±•å­—æ®µã€‚
    - ç¤ºä¾‹ï¼š
        
        ```json
        {
          "provider": "hetzner",
          "plan": "cx22",
          "region": "eu-central",
          "invoice_id": "inv_2025_06_001",
          "tax_included": true
        }
        
        ```
        
    - è®¾è®¡åŸåˆ™ï¼š
        - é¡¶å±‚ key å»ºè®®å¯è¯»ã€ç¨³å®šï¼›
        - ä¸åœ¨ v1.0 ä¸­å¼ºè¡Œæ ‡å‡†åŒ–ï¼Œä¿ç•™å„ Provider / é›†æˆæ–¹çš„çµæ´»ç©ºé—´ï¼›
        - çœŸæ­£éœ€è¦ç»Ÿè®¡çš„å­—æ®µï¼Œæœªæ¥å¯ä»¥æå‡ä¸ºä¸€çº§å­—æ®µæˆ–å®šä¹‰ä¸“é—¨çš„ meta-schemaã€‚

---

### 3.6 æ—¶é—´ç»´åº¦

- `occurred_at`
    - ç±»å‹ï¼šæ—¶é—´å­—ç¬¦ä¸²ï¼ˆISO8601ï¼‰
    - å«ä¹‰ï¼š**ä¸šåŠ¡è¯­ä¹‰ä¸Šçš„å‘ç”Ÿæ—¶é—´**ï¼Œä¾‹å¦‚ï¼š
        - äº‘å‚å•†è´¦å•è¡Œçš„ç”Ÿæ•ˆæ—¶é—´ï¼›
        - VCC äº¤æ˜“å®é™…å‘ç”Ÿæ—¶é—´ï¼›
        - ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶ç¡®è®¤æˆæœ¬çš„æ—¶é—´ç‚¹ã€‚
- `recorded_at`
    - ç±»å‹ï¼šæ—¶é—´å­—ç¬¦ä¸²
    - å«ä¹‰ï¼šLedgerEntry è¢«å†™å…¥ CREEP çš„æ—¶é—´ã€‚
    - ç”¨é€”ï¼š
        - åŒºåˆ†â€œè´¦ç›®å‘ç”Ÿæ—¶é—´â€å’Œâ€œè®°è´¦ç”Ÿæ•ˆæ—¶é—´â€ï¼›
        - æ”¯æŒå»¶è¿Ÿè®°è´¦ã€è¿½æº¯è¡¥è®°åœºæ™¯ã€‚

---

### 4. è®¾è®¡æ„å›¾

1. **é‡‘é¢æ°¸è¿œä¸ºæ­£ï¼Œæ–¹å‘ç”± direction å†³å®š**
    - é¿å…åˆ°å¤„å‡ºç°æ­£è´Ÿå·å¯¼è‡´çš„æ··ä¹±ï¼›
    - é€»è¾‘ä¸Šï¼Œ`OUT` å°±æ˜¯â€œç§Ÿæˆ·ä»˜å‡ºå»çš„é’±â€ï¼›`IN` å°±æ˜¯â€œç§Ÿæˆ·æ”¶åˆ°çš„é’±â€ï¼›
    - å†²é”€/é€€æ¬¾é€šè¿‡åå‘ entry å®ç°ï¼Œè€Œä¸æ˜¯ç›´æ¥æ›´æ–°ã€‚
2. **è§£è€¦è´¦ç›®ç»´åº¦ä¸ä¸šåŠ¡ç»´åº¦**
    - è´¦ç›®å¿…é¡»èƒ½ä»ä»¥ä¸‹ç»´åº¦æŸ¥è¯¢ï¼š
        - ç§Ÿæˆ· (`tenant_id`)
        - é¡¹ç›® (`project_id`)
        - ç¯å¢ƒ (`env`)
        - ä»»åŠ¡ (`task_id`)
        - èµ„äº§ (`asset_id`)
        - å¤–éƒ¨è´¦å• (`external_ref`)
    - è¿™ä¿è¯ï¼š
        - å¯ä»¥é—®ï¼šâ€œè¿™ä¸ªé¡¹ç›®æœ¬æœˆ QA çƒ§äº†å¤šå°‘ IP æˆæœ¬ï¼Ÿâ€
        - ä¹Ÿå¯ä»¥é—®ï¼šâ€œè¿™å° VPS ä¸€ç”Ÿæ€»å…±è¢«å“ªä¸ªä»»åŠ¡çƒ§äº†å¤šå°‘é’±ï¼Ÿâ€
3. **ä¸ Provider å¯¹è´¦çš„ä¸€ç­‰å…¬æ°‘**
    - `external_ref` + `meta` å°±æ˜¯â€œæˆ‘è¿™ä¸€è¡Œè´¦æ˜¯å¯¹å¤–éƒ¨å“ªä¸€è¡Œ/å“ªä¸€ç¬”â€çš„é”šç‚¹ï¼›
    - ä¸éœ€è¦åœ¨ AssetSnapshot/TaskOrder é‡Œå¡ä¸€å †è´¦å•å·ã€‚
4. **ä¸ AssetSnapshot / TaskOrder çš„èŒè´£è¾¹ç•Œ**
    - AssetSnapshotï¼š
        - åªå­˜ acquisition_cost / estimated_unit_cost / expected_value ç­‰**é™æ€è§†è§’**ï¼›
    - TaskOrderï¼š
        - åªå­˜ max_total_cost ç­‰**é¢„ç®—è§†è§’**ï¼›
    - LedgerEntryï¼š
        - è´Ÿè´£â€œå‘ç”Ÿäº†å¤šå°‘é’±çš„çœŸå®æµåŠ¨â€ï¼Œ
            
            æ˜¯ FinOps çš„å”¯ä¸€çœŸç›¸ã€‚
            

---

### 5. åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šè´­ä¹°ä¸€æ‰¹è‹±å›½ Residential IP

- TaskOrderï¼š`task_type = "PROCUREMENT"`, `env = "prod"`
- è°ƒç”¨æŸ IP ä¾›åº”å•† API é‡‡è´­ 100 ä¸ª IPï¼ŒèŠ±äº† 20 USD

ç”Ÿæˆä¸€æ¡ LedgerEntryï¼š

```json
{
  "ledger_entry_id": "uuid-1",
  "tenant_id": "tenant_a",
  "project_id": "project_qa",
  "env": "prod",
  "asset_id": null,
  "task_id": "task-procure-123",
  "external_ref": "ipvendor_tx_789",
  "direction": "OUT",
  "amount": 20.0,
  "currency": "USD",
  "reason": "PROCUREMENT",
  "category": "NETWORK_COST",
  "tags": ["ip", "residential", "uk"],
  "meta": {
    "provider": "iproyal",
    "sku": "ip.residential.uk.*",
    "quantity": 100
  },
  "occurred_at": "2025-06-22T10:00:00Z",
  "recorded_at": "2025-06-22T10:00:02Z"
}

```

### åœºæ™¯ 2ï¼šä¸€å° VPS è¢«ç”¨äº 100 æ¬¡ QA ä»»åŠ¡ï¼Œæ¯æ¬¡æ‘Šé”€æˆæœ¬

- å…ˆæœ‰ä¸€æ¡é‡‡è´­ VPS çš„ OUT è´¦ç›®ï¼›
- ä¹‹åæ¯ä¸ª Task å®Œæˆæ—¶ï¼Œæ ¹æ®ç­–ç•¥â€œæ‘Šé”€â€ä¸€å°éƒ¨åˆ†æˆæœ¬åˆ°å„ Task ä¸Šï¼š

```json
{
  "ledger_entry_id": "uuid-2",
  "tenant_id": "tenant_a",
  "project_id": "project_qa",
  "env": "prod",
  "asset_id": "vps-asset-id-1",
  "task_id": "task-e2e-456",
  "external_ref": null,
  "direction": "OUT",
  "amount": 0.05,
  "currency": "USD",
  "reason": "TASK_BURN",
  "category": "CLOUD_COST",
  "tags": ["qa", "e2e"],
  "meta": {
    "allocation_strategy": "proportional_runtime",
    "runtime_ms": 120000
  },
  "occurred_at": "2025-06-22T11:05:00Z",
  "recorded_at": "2025-06-22T11:05:01Z"
}

```

### åœºæ™¯ 3ï¼šå‡ºå”®ä¸€å¼ æ¼”å”±ä¼šé—¨ç¥¨ PRODUCT

- TaskOrderï¼š`task_type = "TICKET_SALE"`
- AssetSnapshotï¼šPRODUCT èµ„äº§ä»£è¡¨è¿™å¼ ç¥¨æœ¬èº«

ç”Ÿæˆä¸€æ¡æ”¶å…¥ LedgerEntryï¼š

```json
{
  "ledger_entry_id": "uuid-3",
  "tenant_id": "tenant_a",
  "project_id": "project_ticket",
  "env": "prod",
  "asset_id": "product-ticket-asset-id",
  "task_id": "task-sale-999",
  "external_ref": "stripe_charge_abc",
  "direction": "IN",
  "amount": 120.0,
  "currency": "USD",
  "reason": "SALE_REVENUE",
  "category": "PRODUCT_REVENUE",
  "tags": ["taylor_swift", "london"],
  "meta": {
    "payment_provider": "stripe",
    "fee_amount": 3.5,
    "fee_currency": "USD"
  },
  "occurred_at": "2025-06-22T20:00:00Z",
  "recorded_at": "2025-06-22T20:00:01Z"
}

```

---

### 6. ä¸å…¶ä»– Schema çš„åä½œå…³ç³»ï¼ˆç®€è¦ï¼‰

- ä¸ `AssetSnapshot v1.0`ï¼š
    - `asset_id` è¿æ¥å…·ä½“èµ„äº§ï¼›
    - å¯æ ¹æ®æŸä¸ªèµ„äº§çš„ LedgerEntry æ±‡æ€»å…¶â€œç»ˆèº«æˆæœ¬ / ç»ˆèº«æ”¶å…¥â€ã€‚
- ä¸ `TaskOrder v1.0`ï¼š
    - `task_id` å°†æ‰€æœ‰æˆæœ¬ / æ”¶å…¥æŒ‚åœ¨ä»»åŠ¡ä¸Šï¼Œæ”¯æŒï¼š
        - â€œè¿™ä¸ªä»»åŠ¡çƒ§äº†å¤šå°‘é’±ï¼Ÿâ€
        - â€œè¿™ä¸€ç±»ä»»åŠ¡å¹³å‡å•æ¬¡æˆæœ¬æ˜¯å¤šå°‘ï¼Ÿâ€
- ä¸ `AssetEvent v1.0`ï¼ˆå³å°†ç«‹ï¼‰ï¼š
    - AssetEvent è®°å½•â€œå‘ç”Ÿäº†ä»€ä¹ˆâ€ï¼›
    - LedgerEntry è®°å½•â€œå› æ­¤èŠ±/èµšäº†å¤šå°‘é’±â€ï¼›
    - ä¸¤è€…é€šè¿‡ `asset_id` / `task_id` æ±‡æ€»æˆå®Œæ•´æ•…äº‹çº¿ã€‚
